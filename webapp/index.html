<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
  </head>
  <body>
    <h1>斎藤友の YouTube IFrame Player API のテストサイトへようこそ！</h1>
    動画IDは <div id='broadcast_id'>a4XdAOxSLxs</div> です <br>
    <hr>
    ここに動画中にLINEに送った写真が表示されます<br>
    <div id='image-container'></div>
    <hr>
    この下に YouTube動画 が張り付いているはず～ <br>
    
    <!-- 1. The <iframe> (and video player) will replace this <div> tag. -->
    <div id="player"></div> <!-- ★ ここが <iframe> に置換される -->

    <br>この上に YouTube動画 が張り付いているはず～ <br>
    <hr>

    <script>
      // URLのクエリパラメータをパースする
      const urlParams = new URLSearchParams(window.location.search);

      // "id"パラメータの値を取得する
      const id = urlParams.get('id');

      // IDで指定された<div>要素を取得する
      const divElement = document.getElementById('broadcast_id');

      // <div>要素の中の文字列を取得する
      //const divText = divElement.innerHTML;

      // 置換を行う
      //const replacedText = divText.replace("置換前の文字列", "置換後の文字列");

      // <div>要素の中の文字列を置換された文字列に更新する
      if (id) {
        divElement.innerHTML = id;
      }
      
      // JSONファイルのURLを指定
      const url = 'https://youtube-iframe-player-api-test.s3.ap-northeast-1.amazonaws.com/' + id + '/list.json';

      // 画像要素を追加するDOM要素を取得
      const imageContainer = document.getElementById('image-container');
      
      async function addImagesFromJson() {
        try {
          fetch(url)
            .then(response => response.json())
            .then(data => {
              console.log(data)

              // 画像のURLから画像要素を作成し、DOMに追加
              data.files.forEach(imageItem => {
                console.log(imageItem);
                console.log(imageItem.key.toString());
                const img_url = "https://youtube-iframe-player-api-test.s3.ap-northeast-1.amazonaws.com/" + imageItem.key.toString();
                console.log(img_url);
                if (img_url.endsWith('.jpg')) {
                  const img = document.createElement('img');
                  img.src = img_url;
                  img.style.width = "10%";
                  img.style.height = "10%";
                  imageContainer.appendChild(img);
                }
              });
          });
        } catch (err) {
          console.log(err);
        }
      }

      addImagesFromJson();

      // 2. This code loads the IFrame Player API code asynchronously.
      var tag = document.createElement('script');

      tag.src = "https://www.youtube.com/iframe_api";
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      // 3. This function creates an <iframe> (and YouTube player)
      //    after the API code downloads.
      var player;
      function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', { // ★ ここで <div id="player"></div> を探り当てている
                                           // ★ YT は youtube.com/iframe_api で定義されている
          height: '360',
          width: '640',
          videoId: id ? id : 'a4XdAOxSLxs', // ★ Broadcast ID
          events: {
            'onReady': onPlayerReady,             // ★ YouTube Player の準備完了
            'onStateChange': onPlayerStateChange  // ★ YouTube Player のステータス変更
          }
        });
      }

      // 4. The API will call this function when the video player is ready.
      function onPlayerReady(event) {
        player.playVideo(); // ★ 準備完了したら再生開始
      }

      // 5. The API calls this function when the player's state changes.
      //    The function indicates that when playing a video (state=1),
      //    the player should play for six seconds and then stop.
      var done = false;
      function onPlayerStateChange(event) {
        if (event.data == YT.PlayerState.PLAYING && !done) { // ★ PLAYINGになったら...
          setTimeout(stopVideo, 6000);                       // ★ 6秒後に stopVideo をコール(仕込み)
          done = true;
        }
      }
      function stopVideo() {
        player.stopVideo(); // ★ 再生停止
      }
    </script>
  </body>
</html>
